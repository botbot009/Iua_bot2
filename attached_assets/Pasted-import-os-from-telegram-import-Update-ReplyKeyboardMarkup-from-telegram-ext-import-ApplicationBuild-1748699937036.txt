import os
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes
from flask import Flask
from threading import Thread

# ğŸ” Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
BOT_TOKEN = os.environ.get("BOT_TOKEN", "Ø¶Ø¹ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§ Ø¥Ù† Ù„Ù… ØªØ¶Ù ENV")

# ğŸ”„ Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø§Ø¯Ù… Flask Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±
app_flask = Flask('')

@app_flask.route('/')
def home():
    return "âœ… Bot is alive and running."

def run():
    app_flask.run(host='0.0.0.0', port=8080)

def keep_alive():
    Thread(target=run).start()

# ğŸ—‚ï¸ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ù„ÙƒÙ„ Ø³Ù…Ø³ØªØ±
semester_subjects = {
    "Ø§Ù„Ø³Ù…Ø³ØªØ± Ø§Ù„Ø³Ø§Ø¨Ø¹": [
        "Ù‡Ù†Ø¯Ø³Ø© Ø·Ø±Ù‚ 1", "Ù‡ÙŠØ¯Ø±ÙˆÙ„ÙŠÙƒØ§ 1", "ØªØµÙ…ÙŠÙ… Ø®Ø±Ø³Ø§Ù†Ø© 2", "Ø­Ø³Ø§Ø¨ ÙƒÙ…ÙŠØ§Øª",
        "Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ§ ØªØ±Ø¨Ø© 2", "ØªØµÙ…ÙŠÙ… ÙÙˆÙ„Ø§Ø° 1", "Ø§Ù‚ØªØµØ§Ø¯ Ù‡Ù†Ø¯Ø³ÙŠ",
        "ÙÙƒØ± Ø§Ø³Ù„Ø§Ù…ÙŠ", "ÙˆØ§Ù‚Ø¹ Ø§Ø³Ù„Ø§Ù…ÙŠ"
    ],
    "Ø§Ù„Ø³Ù…Ø³ØªØ± Ø§Ù„Ø«Ø§Ù…Ù†": [
        "Ù‡Ù†Ø¯Ø³Ø© Ø·Ø±Ù‚ 2", "Ù‡ÙŠØ¯Ø±ÙˆÙ„ÙŠÙƒØ§ 2", "ØªØµÙ…ÙŠÙ… Ø®Ø±Ø³Ø§Ù†Ø© 3", "Ø¥Ø¯Ø§Ø±Ø© ØªØ´ÙŠÙŠØ¯",
        "ØªØµÙ…ÙŠÙ… ÙÙˆÙ„Ø§Ø° 2", "Ù‡Ù†Ø¯Ø³Ø© Ø¨ÙŠØ¦ÙŠØ©", "Ø¯Ø±Ø§Ø³Ø§Øª Ù‚Ø±Ø¢Ù†ÙŠØ©"
    ]
}

user_state = {}

# âœ… Ø£Ù…Ø± /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [["Ø§Ù„Ø³Ù…Ø³ØªØ± Ø§Ù„Ø³Ø§Ø¨Ø¹", "Ø§Ù„Ø³Ù…Ø³ØªØ± Ø§Ù„Ø«Ø§Ù…Ù†"]]
    reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)
    await update.message.reply_text("ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø§Ø®ØªØ± Ø§Ù„Ø³Ù…Ø³ØªØ±:", reply_markup=reply_markup)

# ğŸ’¬ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    user_id = update.message.from_user.id

    if text in semester_subjects:
        user_state[user_id] = {"semester": text}
        keyboard = [[subject] for subject in semester_subjects[text]]
        reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)
        await update.message.reply_text("ğŸ“š Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©:", reply_markup=reply_markup)

    elif user_id in user_state and "semester" in user_state[user_id] and "subject" not in user_state[user_id]:
        user_state[user_id]["subject"] = text
        await update.message.reply_text(f"âœ… Ø§Ø®ØªØ±Øª Ø§Ù„Ù…Ø§Ø¯Ø©: {text}. Ø£Ø±Ø³Ù„ Ø§Ù„Ø¢Ù† Ø§Ù„Ù…Ù„Ù.")

        semester_folder = "semester7" if "Ø§Ù„Ø³Ø§Ø¨Ø¹" in user_state[user_id]["semester"] else "semester8"
        subject_folder = user_state[user_id]["subject"]
        full_path = os.path.join(semester_folder, subject_folder)
        os.makedirs(full_path, exist_ok=True)

        files = os.listdir(full_path)
        if files:
            for f in files:
                file_path = os.path.join(full_path, f)
                await update.message.reply_document(document=open(file_path, "rb"), caption=f)
        else:
            await update.message.reply_text("ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©.")

# ğŸ“ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª
async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id

    if user_id not in user_state or "semester" not in user_state[user_id] or "subject" not in user_state[user_id]:
        await update.message.reply_text("â—ï¸ÙŠØ±Ø¬Ù‰ Ø£ÙˆÙ„Ø§Ù‹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù…Ø³ØªØ± ÙˆØ§Ù„Ù…Ø§Ø¯Ø©.")
        return

    file = update.message.document
    file_name = file.file_name

    semester_folder = "semester7" if "Ø§Ù„Ø³Ø§Ø¨Ø¹" in user_state[user_id]["semester"] else "semester8"
    subject_folder = user_state[user_id]["subject"]
    save_path = os.path.join(semester_folder, subject_folder)
    os.makedirs(save_path, exist_ok=True)

    file_path = os.path.join(save_path, file_name)
    await file.download_to_drive(file_path)

    await update.message.reply_text(f"ğŸ“¥ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù: {file_name} âœ…")

# ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
def main():
    keep_alive()  # Ù„ØªØ´ØºÙŠÙ„ Flask
    app = ApplicationBuilder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Document.ALL, handle_document))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), handle_message))
    print("ğŸ¤– Bot is running...")
    app.run_polling()

if __name__ == "__main__":
    main()
