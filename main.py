import os
from flask import Flask, request
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes
import asyncio

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
TOKEN = os.environ.get("BOT_TOKEN")
WEBHOOK_URL = os.environ.get("WEBHOOK_URL")  # Ù…Ø«Ø§Ù„: https://xxxxxx.up.railway.app/webhook

# ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†
if not TOKEN:
    raise ValueError("âŒ BOT_TOKEN ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©")

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯
semester_data = {
    "Ø§Ù„Ø³Ø§Ø¨Ø¹": [
        "Ø§Ù‚ØªØµØ§Ø¯ Ù‡Ù†Ø¯Ø³ÙŠ", "ØªØµÙ…ÙŠÙ… Ø®Ø±Ø³Ø§Ù†Ø© 2", "ØªØµÙ…ÙŠÙ… ÙÙˆÙ„Ø§Ø° 1", "Ø­Ø³Ø§Ø¨ ÙƒÙ…ÙŠØ§Øª", "ÙÙƒØ± Ø¥Ø³Ù„Ø§Ù…ÙŠ",
        "Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ ØªØ±Ø¨Ø© 2", "Ù‡Ù†Ø¯Ø³Ø© Ø·Ø±Ù‚ 1", "Ù‡ÙŠØ¯Ø±ÙˆÙ„ÙŠÙƒØ§ 1", "ÙˆØ§Ù‚Ø¹ Ø¥Ø³Ù„Ø§Ù…ÙŠ"
    ],
    "Ø§Ù„Ø«Ø§Ù…Ù†": [
        "Ø¥Ø¯Ø§Ø±Ø© ØªØ´ÙŠÙŠØ¯", "ØªØµÙ…ÙŠÙ… Ø®Ø±Ø³Ø§Ù†Ø© 3", "ØªØµÙ…ÙŠÙ… ÙÙˆÙ„Ø§Ø° 2", "Ø¯Ø±Ø§Ø³Ø§Øª Ù‚Ø±Ø¢Ù†ÙŠØ©",
        "Ù‡Ù†Ø¯Ø³Ø© Ø¨ÙŠØ¦ÙŠØ©", "Ù‡Ù†Ø¯Ø³Ø© Ø·Ø±Ù‚ 2", "Ù‡ÙŠØ¯Ø±ÙˆÙ„ÙŠÙƒØ§ 2"
    ]
}

# Flask app
app = Flask(__name__)

# Telegram App
telegram_app = Application.builder().token(TOKEN).build()

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("ğŸ“š Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø§Ø¨Ø¹", callback_data='Ø§Ù„Ø³Ø§Ø¨Ø¹')],
        [InlineKeyboardButton("ğŸ“˜ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù…Ù†", callback_data='Ø§Ù„Ø«Ø§Ù…Ù†')]
    ]
    await update.message.reply_text("ğŸ“– Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:", reply_markup=InlineKeyboardMarkup(keyboard))

# Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    if data in semester_data:
        buttons = [[InlineKeyboardButton(subject, callback_data="none")] for subject in semester_data[data]]
        await query.edit_message_text(f"ğŸ“˜ Ù…ÙˆØ§Ø¯ Ø§Ù„ÙØµÙ„ {data}:", reply_markup=InlineKeyboardMarkup(buttons))
    else:
        await query.edit_message_text("ğŸ“Œ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.")

# ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù†Ø¯Ù„Ø±Ø§Øª
telegram_app.add_handler(CommandHandler("start", start))
telegram_app.add_handler(CallbackQueryHandler(button_handler))

# Webhook endpoint
@app.route("/webhook", methods=["POST"])
def webhook():
    update = Update.de_json(request.get_json(force=True), telegram_app.bot)
    telegram_app.update_queue.put_nowait(update)
    return "ok"

# ÙØ­Øµ Ø§Ù„Ø¨ÙˆØª
@app.route("/", methods=["GET"])
def home():
    return "âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Railway"

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù€ Webhook
async def main():
    await telegram_app.bot.set_webhook(url=WEBHOOK_URL)
    print("âœ… Webhook set")

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ webhook Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
@app.before_first_request
def activate_webhook():
    loop = asyncio.get_event_loop()
    loop.create_task(main())

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)
